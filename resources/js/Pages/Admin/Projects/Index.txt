<script setup lang="ts">
import Navheader from '@/Components/Backend/Navheader.vue';
import AuthLayout from '@/Layouts/AuthLayout.vue';
import { Image, Project } from '@/types';
import { Head, Link } from '@inertiajs/vue3';
import { IconDeviceProjector, IconInbox, IconDots, IconPhotoX, IconPencil, IconTableShortcut } from '@tabler/icons-vue';
import { computed } from 'vue';
import { Menu, MenuButton, MenuItem, MenuItems } from "@headlessui/vue";
import Footnote from "@/Components/Front/Footnote.vue";

const props = defineProps<{
  projects: Project[],
}>()

// Extract images from all projects
const allImages = computed(() => {
  return props.projects.flatMap(project => project.images ?? []);
});

// Function to determine the grid span based on image size (dynamic span)
function getGridSpan(image: Image) {

  const [width, height] = image.size.split('x').map(Number);

  // Return the number of rows to span based on the image's height
  return Math.ceil(height / 200);
}

const deleteImage = (id: Number) => {
  console.log("Delete image with ID:", id);
  // Implement the delete functionality
};

const editProject = (projectId: Number) => {
  console.log("Edit bucket with ID:", projectId);
  // Implement the edit functionality
};

defineOptions({
  layout: AuthLayout
})
</script>

<template>

  <Head title="Available Projects" />

  <Navheader>

    <nav
      class="flex items-center w-full gap-6 dark:text-white dark:border-gray-700">

      <Link
        as="button"
        v-if="allImages.length"
        :href="route('auth.projects.create')"
        class="flex items-center gap-2 py-2 font-semibold transition duration-300 hover:opacity-70">
        <IconDeviceProjector class="w-5 h-5 stroke-current" /> <span>Add new</span>
      </Link>

      <h2 v-else class="text-xl font-semibold py-1.5">
        Explore projects
      </h2>

    </nav>

  </Navheader>

  <main class="max-w-2xl px-4 py-10 mx-auto sm:px-6 lg:px-8 lg:py-14">

    <div v-if="allImages.length" class="w-full">

      <div class="gap-4 space-y-4 columns-2 sm:columns-3" :style="allImages.length > 3 ? 'direction: rtl;' : ''">

        <div
          v-for="(image, index) in allImages" :key="index"
          class="relative break-inside-avoid group">

          <img
            :src="image.src"
            @contextmenu.prevent
            :alt="'Project image ' + index + 1"
            class="w-full rounded-lg shadow-lg">

          <!-- Action Buttons (shown on hover) -->
          <div
            class="absolute flex items-center transition-opacity duration-300 opacity-0 gap-x-1 bottom-1 right-1 group-hover:opacity-100" style="direction: ltr;">

            <!-- Edit Button -->
            <Link
              as="button"
              preserve-scroll
              :href="route('auth.projects.edit', image.model_id)"
              class="p-1 text-blue-500 bg-gray-200 rounded-lg hover:text-blue-600"
            >
              <IconPencil size="24" />
            </Link>

            <Menu as="div" class="relative inline-block text-left z-40">
              <div>
                <MenuButton
                  class="inline-flex w-full justify-center rounded-md bg-black/20 p-2 text-sm font-medium text-white hover:bg-black/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-white/75"
                >
                  <IconDots
                    class="h-5 w-5 text-violet-200 hover:text-violet-100"
                    aria-hidden="true"
                  />
                </MenuButton>
              </div>

              <transition
                enter-active-class="transition duration-100 ease-out"
                enter-from-class="transform scale-95 opacity-0"
                enter-to-class="transform scale-100 opacity-100"
                leave-active-class="transition duration-75 ease-in"
                leave-from-class="transform scale-100 opacity-100"
                leave-to-class="transform scale-95 opacity-0"
              >
                <MenuItems
                  class="absolute right-0 mt-2 w-24 origin-bottom-right divide-y divide-gray-100 rounded-md bg-white shadow-lg ring-1 ring-black/5 focus:outline-none"
                >
                  <div class="px-1 py-1">
                    <MenuItem v-slot="{ active }">
                      <Link
                        as="button"
                        method="delete"
                        :class="[
                          active ? 'bg-violet-500 text-white' : 'text-gray-900',
                          'group flex w-full items-center rounded-md px-2 py-2 text-sm',
                        ]"
                        :href="route('auth.projects.destroy', image.model_id)"
                      >
                        <IconTableShortcut
                          :active="active"
                          class="mr-2 h-5 w-5 text-violet-400"
                          aria-hidden="true"
                        />
                        Project
                      </Link>
                    </MenuItem>

                    <MenuItem v-slot="{ active }">
                      <Link
                        as="button"
                        method="delete"
                        :class="[
                          active ? 'bg-violet-500 text-white' : 'text-gray-900',
                          'group flex w-full items-center rounded-md px-2 py-2 text-sm',
                        ]"
                        :href="route('auth.projects.destroy', { project: image.model_id, image: image.id })"
                      >
                        <IconPhotoX
                          :active="active"
                          class="mr-2 h-5 w-5 text-violet-400"
                          aria-hidden="true"
                        />
                        Image
                      </Link>
                    </MenuItem>
                  </div>

                </MenuItems>

              </transition>

            </Menu>

          </div>

        </div>

      </div>

    </div>

    <!-- No Projects Found Section -->
    <div v-else class="flex flex-col items-center justify-center text-center dark:text-gray-400">

      <IconInbox class="w-24 h-24 mb-6 text-gray-400 dark:text-gray-600" />

      <h2 class="text-2xl font-semibold mb-2">No Projects Found</h2>

      <p class="text-lg text-gray-600 dark:text-gray-400">
        It seems like there are no projects available at the moment.
      </p>

      <Link
        as="button"
        :href="route('auth.projects.create')"
        class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
        <IconDeviceProjector class="w-5 h-5 inline-block mr-2" /> Add New Project
      </Link>
    </div>

  </main>

  <Footnote />

</template>
